<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>awk cheatsheet</title>
<script id="hp_same_"></script><script id="hp_done_"></script><link rel="stylesheet" href="../css/main.css?version=1634529334957"><link rel="stylesheet" href="../css/prism.css?version=1634529334957"></head>

<body>
    <script>
        if (!location.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)
            && location.hostname !== 'localhost'
        ) {
            if (location.protocol === 'http:') {
                // https 跳转
                location.href = 'https:' + location.href.substring(window.location.protocol.length)
            } else if (location.pathname === '/') {
                // 静态跳转
                if ((/#\/[^/]+/).test(location.hash)) {
                    location.href = `https://${location.hostname}/docs/${location.hash.substring(2)}.html`
                } else {
                    location.href = `https://${location.hostname}/docs/`
                }
            }
        }
        let isHtml = true
    </script>

    <div id="loading" class="hide" data-cs-theme="light"></div>
    <div id="top-nav" data-cs-theme="light">
        <div class="top-nav__wrapper">
            <div id="go-back" onclick="history.go(-1)">返回</div>
            <a id="go-home" href="./index.html">首页</a>

        </div>
    </div>
    <div id="main">
        <div id="sheet-wrapper">
            <div id="sheet-title">
                <h1>Awk<span> cheatsheet</span></h1>
            </div>
            <div id="sheet-body">
                
                            <div class="h2-section" style="height: 1123px">
                                
                                
                            <div class="sheet-section"  data-position="580|0|0">
                                <div class="section-title"><h3 id="id-222">开始</h3></div>
                                <div class="section-body">
                                    <h4>从netstat命令中提取了如下信息作为用例</h4>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Proto Recv-Q Send-Q Local-Address          Foreign-Address             State
tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN
tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN
tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN
tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT
tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2
tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED
tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2
tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED
tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT
tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED
tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1
tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED
tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT
tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK
tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED
tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2
tcp        0      0 :::22                  :::*                        LISTEN
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|0">
                                <div class="section-title"><h3 id="id-223">第一个例子</h3></div>
                                <div class="section-body">
                                    <p>其中单引号中的被<em>大括号</em>括着的就是<code>awk</code>的语句，注意，其只能被<em>单引号</em>包含。</p>
<p>其中的<code>$1..$n</code>表示第几例。注：<code>$0</code>表示整个行。</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>, <span class="token variable">$4</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Proto Local-Address
tcp 0.0.0.0:3306
tcp 0.0.0.0:80
tcp 127.0.0.1:9000
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp coolshell.cn:80
tcp :::22
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|0|554">
                                <div class="section-title"><h3 id="id-224">格式化输出</h3></div>
                                <div class="section-body">
                                    <p><code>awk</code>的格式化输出，和<code>C</code>语言的<code>printf</code>没什么两样：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'{printf "%-8s %-8s %-8s %-18s %-22s %-15s<span class="token entity" title="\n">\n</span>",<span class="token variable">$1</span>,<span class="token variable">$2</span>,<span class="token variable">$3</span>,<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Proto    Recv-Q   Send-Q   Local-Address      Foreign-Address        State
tcp      0        0        0.0.0.0:3306       0.0.0.0:*              LISTEN
tcp      0        0        0.0.0.0:80         0.0.0.0:*              LISTEN
tcp      0        0        127.0.0.1:9000     0.0.0.0:*              LISTEN
tcp      0        0        coolshell.cn:80    124.205.5.146:18245    TIME_WAIT
tcp      0        0        coolshell.cn:80    61.140.101.185:37538   FIN_WAIT2
tcp      0        0        coolshell.cn:80    110.194.134.189:1032   ESTABLISHED
tcp      0        0        coolshell.cn:80    123.169.124.111:49809  ESTABLISHED
tcp      0        0        coolshell.cn:80    116.234.127.77:11502   FIN_WAIT2
tcp      0        0        coolshell.cn:80    123.169.124.111:49829  ESTABLISHED
tcp      0        0        coolshell.cn:80    183.60.215.36:36970    TIME_WAIT
tcp      0        4166     coolshell.cn:80    61.148.242.38:30901    ESTABLISHED
tcp      0        1        coolshell.cn:80    124.152.181.209:26825  FIN_WAIT1
tcp      0        0        coolshell.cn:80    110.194.134.189:4796   ESTABLISHED
tcp      0        0        coolshell.cn:80    183.60.212.163:51082   TIME_WAIT
tcp      0        1        coolshell.cn:80    208.115.113.92:50601   LAST_ACK
tcp      0        0        coolshell.cn:80    123.169.124.111:49840  ESTABLISHED
tcp      0        0        coolshell.cn:80    117.136.20.85:50025    FIN_WAIT2
tcp      0        0        :::22              :::*                   LISTEN
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 1549px">
                                <div class="h2-section-title"><h2 id="id-228">起步</h2></div>
                                
                            <div class="sheet-section" style="width: 580px" data-position="580|0|42">
                                <div class="section-title"><h3 id="id-225">过滤记录</h3></div>
                                <div class="section-body">
                                    <h4>过滤条件为：<em>第3列</em>的值为<code>0</code> &amp;&amp; <em>第6列</em>的值为<code>LISTEN</code></h4>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$3</span>==0 &amp;&amp; <span class="token variable">$6</span>=="LISTEN" '</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 0.0.0.0:3306               0.0.0.0:*              LISTEN
tcp        0      0 0.0.0.0:80                 0.0.0.0:*              LISTEN
tcp        0      0 127.0.0.1:9000             0.0.0.0:*              LISTEN
tcp        0      0 :::22                      :::*                   LISTEN
</code></pre>
<p>其中的<code>==</code>为比较运算符。其他比较运算符：<code>!=</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code></p>
<p>各种过滤记录的方式:</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">' <span class="token variable">$3</span>&gt;0 {print <span class="token variable">$0</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Proto Recv-Q Send-Q Local-Address          Foreign-Address             State
tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED
tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1
tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK
</code></pre>
<p>如果需要表头的话，可以引入内建变量NR</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$3</span>==0 &amp;&amp; <span class="token variable">$6</span>=="LISTEN" || NR==1 '</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Proto Recv-Q Send-Q Local-Address          Foreign-Address             State
tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN
tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN
tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN
tcp        0      0 :::22                  :::*                        LISTEN
</code></pre>
<p>再加上格式化输出：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$3</span>==0 &amp;&amp; <span class="token variable">$6</span>=="LISTEN" || NR==1 {printf "%-20s %-20s %s<span class="token entity" title="\n">\n</span>",<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Local-Address        Foreign-Address      State
0.0.0.0:3306         0.0.0.0:*            LISTEN
0.0.0.0:80           0.0.0.0:*            LISTEN
127.0.0.1:9000       0.0.0.0:*            LISTEN
:::22                :::*                 LISTEN
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section" style="width: 580px" data-position="580|600|42">
                                <div class="section-title"><h3 id="id-226">内建变量</h3></div>
                                <div class="section-body">
                                    
            <table>
                <thead class="hide">
                    <tr>
                        <th>Code</th><th>Description</th>
                    </tr>
                </thead>
                <tbody>
                <tr><td><code>$0</code></td><td>当前记录（这个变量中存放着整个行的内容）</td></tr><tr><td><code>$1~$n</code></td><td>当前记录的第n个字段，字段间由FS分隔</td></tr><tr><td><code>FS</code></td><td>输入字段分隔符 默认是空格或Tab</td></tr><tr><td><code>NF</code></td><td>当前记录中的字段个数，就是有多少列</td></tr><tr><td><code>NR</code></td><td>已经读出的记录数，就是行号，从1开始，<br>如果有多个文件话，这个值也是不断累加中。</td></tr><tr><td><code>FNR</code></td><td>当前记录数，与NR不同的是，这个值会是各个文件自己的行号</td></tr><tr><td><code>RS</code></td><td>输入的记录分隔符， 默认为换行符</td></tr><tr><td><code>OFS</code></td><td>输出字段分隔符， 默认也是空格</td></tr><tr><td><code>ORS</code></td><td>输出的记录分隔符，默认为换行符</td></tr><tr><td><code>FILENAME</code></td><td>当前输入文件的名字</td></tr>
                </tbody>
            </table>
<p>比如：我们如果要输出行号:</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$3</span>==0 &amp;&amp; <span class="token variable">$6</span>=="ESTABLISHED" || NR==1 {printf "%02s %s %-20s %-20s %s<span class="token entity" title="\n">\n</span>",NR, FNR, <span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">01 1 Local-Address        Foreign-Address      State
07 7 coolshell.cn:80      110.194.134.189:1032 ESTABLISHED
08 8 coolshell.cn:80      123.169.124.111:49809 ESTABLISHED
10 10 coolshell.cn:80      123.169.124.111:49829 ESTABLISHED
14 14 coolshell.cn:80      110.194.134.189:4796 ESTABLISHED
17 17 coolshell.cn:80      123.169.124.111:49840 ESTABLISHED
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section" style="width: 580px" data-position="580|600|788">
                                <div class="section-title"><h3 id="id-227">指定分隔符</h3></div>
                                <div class="section-body">
                                    <pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$  <span class="token function">awk</span>  <span class="token string">'BEGIN{FS=":"} {print <span class="token variable">$1</span>,<span class="token variable">$3</span>,<span class="token variable">$6</span>}'</span> /etc/passwd
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">root 0 /root
bin 1 /bin
daemon 2 /sbin
adm 3 /var/adm
lp 4 /var/spool/lpd
sync 5 /sbin
shutdown 6 /sbin
halt 7 /sbin
</code></pre>
<p>上面的命令也等价于：（<code>-F</code>的意思就是指定分隔符）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span>  -F: <span class="token string">'{print <span class="token variable">$1</span>,<span class="token variable">$3</span>,<span class="token variable">$6</span>}'</span> /etc/passwd
</code></pre>
<p>如果要指定多个分隔符，可以这样来：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;"><span class="token function">awk</span> -F <span class="token string">'[;:]'</span>
</code></pre>
<p>再来看一个以<code>\t</code>作为分隔符<em>输出</em>的例子（下面使用/etc/passwd文件，这个文件是以<code>:</code>分隔的）：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span>  -F: <span class="token string">'{print <span class="token variable">$1</span>,<span class="token variable">$3</span>,<span class="token variable">$6</span>}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> /etc/passwd
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">root    0       /root
bin     1       /bin
daemon  2       /sbin
adm     3       /var/adm
lp      4       /var/spool/lpd
sync    5       /sbin
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 2180px">
                                <div class="h2-section-title"><h2 id="id-232">进阶</h2></div>
                                
                            <div class="sheet-section" style="width: 580px" data-position="580|0|42">
                                <div class="section-title"><h3 id="id-229">字符串匹配</h3></div>
                                <div class="section-body">
                                    <pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$6</span> ~ /FIN/ || NR==1 {print NR,<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">1       Local-Address   Foreign-Address State
6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2
9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2
13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1
18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ $ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$6</span> ~ /WAIT/ || NR==1 {print NR,<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">1       Local-Address   Foreign-Address State
5       coolshell.cn:80 124.205.5.146:18245     TIME_WAIT
6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2
9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2
11      coolshell.cn:80 183.60.215.36:36970     TIME_WAIT
13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1
15      coolshell.cn:80 183.60.212.163:51082    TIME_WAIT
18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2
</code></pre>
<p>上面的第一个示例匹配<code>FIN</code>状态， 第二个示例匹配<code>WAIT</code>字样的状态。其实<code>~</code>表示模式开始。<code>/ /</code>中是模式。这就是一个正则表达式的匹配。</p>
<p><code>awk</code>可以像<code>grep</code>一样的去匹配单行：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'/LISTEN/'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN
tcp        0      0 :::22                   :::*                    LISTEN
</code></pre>
<p>可以使用<code>/FIN|TIME/</code>来匹配<code>FIN</code>或者<code>TIME</code>:</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$6</span> ~ /FIN|TIME/ || NR==1 {print NR,<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">1       Local-Address   Foreign-Address State
5       coolshell.cn:80 124.205.5.146:18245     TIME_WAIT
6       coolshell.cn:80 61.140.101.185:37538    FIN_WAIT2
9       coolshell.cn:80 116.234.127.77:11502    FIN_WAIT2
11      coolshell.cn:80 183.60.215.36:36970     TIME_WAIT
13      coolshell.cn:80 124.152.181.209:26825   FIN_WAIT1
15      coolshell.cn:80 183.60.212.163:51082    TIME_WAIT
18      coolshell.cn:80 117.136.20.85:50025     FIN_WAIT2
</code></pre>
<p>再来看看模式取反的例子：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'<span class="token variable">$6</span> !~ /WAIT/ || NR==1 {print NR,<span class="token variable">$4</span>,<span class="token variable">$5</span>,<span class="token variable">$6</span>}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">1       Local-Address   Foreign-Address State
2       0.0.0.0:3306    0.0.0.0:*       LISTEN
3       0.0.0.0:80      0.0.0.0:*       LISTEN
4       127.0.0.1:9000  0.0.0.0:*       LISTEN
7       coolshell.cn:80 110.194.134.189:1032    ESTABLISHED
8       coolshell.cn:80 123.169.124.111:49809   ESTABLISHED
10      coolshell.cn:80 123.169.124.111:49829   ESTABLISHED
12      coolshell.cn:80 61.148.242.38:30901     ESTABLISHED
14      coolshell.cn:80 110.194.134.189:4796    ESTABLISHED
16      coolshell.cn:80 208.115.113.92:50601    LAST_ACK
17      coolshell.cn:80 123.169.124.111:49840   ESTABLISHED
19      :::22   :::*    LISTEN
</code></pre>
<p>或者使用<code>awk '!/WAIT/' netstat.txt</code>进行全行的过滤。</p>
                                </div>
                            </div>

                            <div class="sheet-section" style="width: 580px" data-position="580|600|42">
                                <div class="section-title"><h3 id="id-230">折分文件</h3></div>
                                <div class="section-body">
                                    <p>awk拆分文件很简单，使用重定向就好了。下面这个例子，是按第6列分隔文件（<code>group by</code>，不同值分到不同的文件中），相当的简单（其中的<code>NR!=1</code>表示不处理表头）。</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'NR!=1{print &gt; <span class="token variable">$6</span>}'</span> netstat.txt
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">ls</span>
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">ESTABLISHED  FIN_WAIT1  FIN_WAIT2  LAST_ACK  LISTEN  netstat.txt  TIME_WAIT
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> ESTABLISHED
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED
tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED
tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> FIN_WAIT1
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> FIN_WAIT2
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2
tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2
tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> LAST_ACK
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> LISTEN
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN
tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN
tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN
tcp        0      0 :::22                  :::*                        LISTEN
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> TIME_WAIT
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT
tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT
tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT
</code></pre>
<p>也可以只将指定的列输出到文件：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;"><span class="token function">awk</span> <span class="token string">'NR!=1{print <span class="token variable">$4</span>,<span class="token variable">$5</span> &gt; <span class="token variable">$6</span>}'</span> netstat.txt
</code></pre>
<p>再复杂一点：（注意其中的<code>if-else-if</code>语句，可见awk其实是个脚本解释器）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'NR!=1{if(<span class="token variable">$6</span> ~ /TIME|ESTABLISHED/) print &gt; "1.txt";
else if(<span class="token variable">$6</span> ~ /LISTEN/) print &gt; "2.txt";
else print &gt; "3.txt" }'</span> netstat.txt
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">ls</span> *.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">1.txt  2.txt  3.txt
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> <span class="token number">1</span>.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 coolshell.cn:80        124.205.5.146:18245         TIME_WAIT
tcp        0      0 coolshell.cn:80        110.194.134.189:1032        ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49809       ESTABLISHED
tcp        0      0 coolshell.cn:80        123.169.124.111:49829       ESTABLISHED
tcp        0      0 coolshell.cn:80        183.60.215.36:36970         TIME_WAIT
tcp        0   4166 coolshell.cn:80        61.148.242.38:30901         ESTABLISHED
tcp        0      0 coolshell.cn:80        110.194.134.189:4796        ESTABLISHED
tcp        0      0 coolshell.cn:80        183.60.212.163:51082        TIME_WAIT
tcp        0      0 coolshell.cn:80        123.169.124.111:49840       ESTABLISHED
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> <span class="token number">2</span>.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 0.0.0.0:3306           0.0.0.0:*                   LISTEN
tcp        0      0 0.0.0.0:80             0.0.0.0:*                   LISTEN
tcp        0      0 127.0.0.1:9000         0.0.0.0:*                   LISTEN
tcp        0      0 :::22                  :::*                        LISTEN
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> <span class="token number">3</span>.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">tcp        0      0 coolshell.cn:80        61.140.101.185:37538        FIN_WAIT2
tcp        0      0 coolshell.cn:80        116.234.127.77:11502        FIN_WAIT2
tcp        0      1 coolshell.cn:80        124.152.181.209:26825       FIN_WAIT1
tcp        0      1 coolshell.cn:80        208.115.113.92:50601        LAST_ACK
tcp        0      0 coolshell.cn:80        117.136.20.85:50025         FIN_WAIT2
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section" style="width: 580px" data-position="580|0|1481">
                                <div class="section-title"><h3 id="id-231">统计</h3></div>
                                <div class="section-body">
                                    <p>下面的命令计算所有的C文件，CPP文件和H文件的文件大小总和。</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">ls</span> -l  *.cpp *.c *.h <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{sum+=<span class="token variable">$5</span>} END {print sum}'</span>
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">2511401
</code></pre>
<p>我们再来看一个统计各个connection状态的用法：（我们可以看到一些编程的影子了，大家都是程序员我就不解释了。注意其中的<em>数组</em>的用法）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> <span class="token string">'NR!=1{a[<span class="token variable">$6</span>]++;} END {for (i in a) print i ", " a[i];}'</span> netstat.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">TIME_WAIT, 3
FIN_WAIT1, 1
ESTABLISHED, 6
FIN_WAIT2, 3
LAST_ACK, 1
LISTEN, 4
</code></pre>
<p>再来看看统计每个用户的进程的占了多少内存（注：sum的RSS那一列）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'NR!=1{a[<span class="token variable">$1</span>]+=<span class="token variable">$6</span>;} END { for(i in a) print i ", " a[i]"KB";}'</span>
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">dbus, 540KB
mysql, 99928KB
www, 3264924KB
root, 63644KB
hchen, 6020KB
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                <div class="h2-section" style="height: 1547px">
                    <div class="h2-section-title"><h2 id="id-236">深入</h2></div>
                    
                            <div class="sheet-section" style="width: 580px" data-position="580|0|42">
                                <div class="section-title"><h3 id="id-233">awk脚本</h3></div>
                                <div class="section-body">
                                    <h4>运行前</h4>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">BEGIN <span class="token punctuation">{</span> 这里面放的是执行前的语句 <span class="token punctuation">}</span>
</code></pre>
<h4>运行中</h4>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;"><span class="token punctuation">{</span> 这里面放的是处理每一行时要执行的语句 <span class="token punctuation">}</span>
</code></pre>
<h4>运行后</h4>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">END <span class="token punctuation">{</span>这里面放的是处理完所有的行后要执行的语句 <span class="token punctuation">}</span>
</code></pre>
<h4>案例</h4>
<p>假设有这么一个文件（学生成绩表）：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> score.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Marry   2143 78 84 77
Jack    2321 66 78 45
Tom     2122 48 77 71
Mike    2537 87 97 95
Bob     2415 40 57 62
</code></pre>
<p>我们的awk脚本如下（我没有写有命令行上是因为命令行上不易读，另外也在介绍另一种用法）：</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">cat</span> cal.awk
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;"><span class="token shebang important">#!/bin/awk -f</span>
<span class="token comment">#运行前</span>
BEGIN <span class="token punctuation">{</span>
    math <span class="token operator">=</span> <span class="token number">0</span>
    english <span class="token operator">=</span> <span class="token number">0</span>
    computer <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token builtin class-name">printf</span> <span class="token string">"NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL<span class="token entity" title="\n">\n</span>"</span>
    <span class="token builtin class-name">printf</span> <span class="token string">"---------------------------------------------<span class="token entity" title="\n">\n</span>"</span>
<span class="token punctuation">}</span>
<span class="token comment">#运行中</span>
<span class="token punctuation">{</span>
    <span class="token assign-left variable">math</span><span class="token operator">+=</span><span class="token variable">$3</span>
    <span class="token assign-left variable">english</span><span class="token operator">+=</span><span class="token variable">$4</span>
    <span class="token assign-left variable">computer</span><span class="token operator">+=</span><span class="token variable">$5</span>
    <span class="token builtin class-name">printf</span> <span class="token string">"%-6s %-6s %4d %8d %8d %8d<span class="token entity" title="\n">\n</span>"</span>, <span class="token variable">$1</span>, <span class="token variable">$2</span>, <span class="token variable">$3</span>,<span class="token variable">$4</span>,<span class="token variable">$5</span>, <span class="token variable">$3</span>+<span class="token variable">$4</span>+<span class="token variable">$5</span>
<span class="token punctuation">}</span>
<span class="token comment">#运行后</span>
END <span class="token punctuation">{</span>
    <span class="token builtin class-name">printf</span> <span class="token string">"---------------------------------------------<span class="token entity" title="\n">\n</span>"</span>
    <span class="token builtin class-name">printf</span> <span class="token string">"  TOTAL:%10d %8d %8d <span class="token entity" title="\n">\n</span>"</span>, math, english, computer
    <span class="token builtin class-name">printf</span> <span class="token string">"AVERAGE:%10.2f %8.2f %8.2f<span class="token entity" title="\n">\n</span>"</span>, math/NR, english/NR, computer/NR
<span class="token punctuation">}</span>
</code></pre>
<p>我们来看一下执行结果：（也可以这样运行 <code>./cal.awk score.txt</code>）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> -f cal.awk score.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL
---------------------------------------------
Marry  2143     78       84       77      239
Jack   2321     66       78       45      189
Tom    2122     48       77       71      196
Mike   2537     87       97       95      279
Bob    2415     40       57       62      159
---------------------------------------------
  TOTAL:       319      393      350
AVERAGE:     63.80    78.60    70.00
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section" style="width: 580px" data-position="580|600|42">
                                <div class="section-title"><h3 id="id-234">环境变量</h3></div>
                                <div class="section-body">
                                    <p>即然说到了脚本，我们来看看怎么和环境变量交互：（使用<code>-v</code>参数和<code>ENVIRON</code>，使用<code>ENVIRON</code>的环境变量需要<code>export</code>）</p>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token assign-left variable">x</span><span class="token operator">=</span><span class="token number">5</span>
$ <span class="token assign-left variable">y</span><span class="token operator">=</span><span class="token number">10</span>
$ <span class="token builtin class-name">export</span> y
$ <span class="token builtin class-name">echo</span> <span class="token variable">$x</span> <span class="token variable">$y</span>
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">5 10
</code></pre>
<pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;">$ <span class="token function">awk</span> -v <span class="token assign-left variable">val</span><span class="token operator">=</span><span class="token variable">$x</span> <span class="token string">'{print <span class="token variable">$1</span>, <span class="token variable">$2</span>, <span class="token variable">$3</span>, <span class="token variable">$4</span>+val, <span class="token variable">$5</span>+ENVIRON["y"]}'</span> <span class="token assign-left variable">OFS</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span> score.txt
</code></pre>
<pre class=" language-markup"><code class=" language-markup" style="font-size: 12px !important;">Marry   2143    78      89      87
Jack    2321    66      83      55
Tom     2122    48      82      81
Mike    2537    87      102     105
Bob     2415    40      62      72
</code></pre>
                                </div>
                            </div>

                <div class="sheet-section" style="width: 580px" data-position="580|600|509">
                    <div class="section-title"><h3 id="id-235">几个小例子</h3></div>
                    <div class="section-body">
                        <pre class=" language-bash"><code class=" language-bash" style="font-size: 12px !important;"><span class="token comment">#从file文件中找出长度大于80的行</span>
<span class="token function">awk</span> <span class="token string">'length&gt;80'</span> <span class="token function">file</span>

<span class="token comment">#按连接数查看客户端IP</span>
<span class="token function">netstat</span> -ntu <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$5</span>}'</span> <span class="token operator">|</span> <span class="token function">cut</span> -d: -f1 <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> -c <span class="token operator">|</span> <span class="token function">sort</span> -nr

<span class="token comment">#打印99乘法表</span>
<span class="token function">seq</span> <span class="token number">9</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'H;g'</span> <span class="token operator">|</span> <span class="token function">awk</span> -v <span class="token assign-left variable">RS</span><span class="token operator">=</span><span class="token string">''</span> <span class="token string">'{for(i=1;i&lt;=NF;i++)printf("%dx%d=%d%s", i, NR, i*NR, i==NR?"<span class="token entity" title="\n">\n</span>":"<span class="token entity" title="\t">\t</span>")}'</span> 
</code></pre>
                    </div>
                </div>
                </div>
                
            </div>
            <div id="sheet-nav">
        <div class="nav-wrapper">
            <div class="nav-btn">
                <div class="nav-btn__item nav-btn-top">顶</div>
                <div class="nav-btn__item nav-btn-menu">菜</div>
            </div>
            <div class="nav-content hide">
                    <div class="nav-item nav-type-H3" title="开始" data-id="id-222" data-pid="default">
                        开始
                    </div>
                
                    <div class="nav-item nav-type-H3" title="第一个例子" data-id="id-223" data-pid="default">
                        第一个例子
                    </div>
                
                    <div class="nav-item nav-type-H3" title="格式化输出" data-id="id-224" data-pid="default">
                        格式化输出
                    </div>
                
                    <div class="nav-item nav-type-H2" title="起步" data-id="id-228" data-pid="">
                        起步
                    </div>
                
                    <div class="nav-item nav-type-H3" title="过滤记录" data-id="id-225" data-pid="id-228">
                        过滤记录
                    </div>
                
                    <div class="nav-item nav-type-H3" title="内建变量" data-id="id-226" data-pid="id-228">
                        内建变量
                    </div>
                
                    <div class="nav-item nav-type-H3" title="指定分隔符" data-id="id-227" data-pid="id-228">
                        指定分隔符
                    </div>
                
                    <div class="nav-item nav-type-H2" title="进阶" data-id="id-232" data-pid="">
                        进阶
                    </div>
                
                    <div class="nav-item nav-type-H3" title="字符串匹配" data-id="id-229" data-pid="id-232">
                        字符串匹配
                    </div>
                
                    <div class="nav-item nav-type-H3" title="折分文件" data-id="id-230" data-pid="id-232">
                        折分文件
                    </div>
                
                    <div class="nav-item nav-type-H3" title="统计" data-id="id-231" data-pid="id-232">
                        统计
                    </div>
                
                    <div class="nav-item nav-type-H2" title="深入" data-id="id-236" data-pid="">
                        深入
                    </div>
                
                    <div class="nav-item nav-type-H3" title="awk脚本" data-id="id-233" data-pid="id-236">
                        awk脚本
                    </div>
                
                    <div class="nav-item nav-type-H3" title="环境变量" data-id="id-234" data-pid="id-236">
                        环境变量
                    </div>
                
                    <div class="nav-item nav-type-H3" title="几个小例子" data-id="id-235" data-pid="id-236">
                        几个小例子
                    </div>
                </div>
        </div>
        </div>
        </div></div>

    



<script src="../js/util/function.js?version=1634529334957"></script><script src="../js/util/event-hub.js?version=1634529334957"></script><script src="../js/3rdparty/prism.js?version=1634529334957"></script><script src="../js/module/loading.js?version=1634529334957"></script><script src="../js/module/home.js?version=1634529334957"></script><script src="../js/module/cheatsheet.js?version=1634529334957"></script><script src="../js/module/menu.js?version=1634529334957"></script><script src="../js/3rdparty/jszip.min.js?version=1634529334957"></script><script src="../js/util/saveData.js?version=1634529334957"></script></body></html>