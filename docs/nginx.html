<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nginx cheatsheet</title>
<script id="hp_same_"></script><script id="hp_done_"></script><link rel="stylesheet" href="../css/main.css?version=2021082402"><link rel="stylesheet" href="../css/prism.css?version=2021082402"></head>

<body>
    <script>
        if (!location.hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)
            && location.hostname !== 'localhost'
        ) {
            if (location.protocol === 'http:') {
                // https 跳转
                location.href = 'https:' + location.href.substring(window.location.protocol.length)
            } else if (location.pathname === '/') {
                // 静态跳转
                if ((/#\/[^/]+/).test(location.hash)) {
                    location.href = `https://${location.hostname}/docs/${location.hash.substring(2)}.html`
                } else {
                    location.href = `https://${location.hostname}/docs/`
                }
            }
        }
        let isHtml = true
    </script>

    <div id="loading" class="hide" data-cs-theme="light"></div>
    <div id="top-nav" data-cs-theme="light">
        <div class="top-nav__wrapper">
            <div id="go-back" onclick="history.go(-1)">返回</div>
            <a id="go-home" href="./index.html">首页</a>

        </div>
    </div>
    <div id="main">
        <div id="sheet-wrapper">
            <div id="sheet-title">
                <h1>nginx<span> cheatsheet</span></h1>
            </div>
            <div id="sheet-body">
                
                            <div class="h2-section" style="height: 642px">
                                
                                
                            <div class="sheet-section"  data-position="580|0|0">
                                <div class="section-title"><h3 id="id-456">端口 <code>listen</code></h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token comment"># 标准 HTTP 端口</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  
  <span class="token comment"># 标准 HTTPS 端口</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 使用 IPv6 监听 80 端口</span>
  <span class="token directive"><span class="token keyword">listen</span> [::]:80</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 仅监听 IPv6 端口</span>
  <span class="token directive"><span class="token keyword">listen</span> [::]:80 ipv6only=on</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|0">
                                <div class="section-title"><h3 id="id-457">域名 <code>server_name</code></h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token comment"># 监听域名 yourdomain.com</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 监听多个域名</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com www.yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 监听所有子域名</span>
  <span class="token directive"><span class="token keyword">server_name</span> *.yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 监听所有顶级域名</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.*</span><span class="token punctuation">;</span>
  
  <span class="token comment"># 监听未指定域名 (listens to IP address itself)</span>
  <span class="token directive"><span class="token keyword">server_name</span> <span class="token string">""</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|0|351">
                                <div class="section-title"><h3 id="id-458">访问日志 <code>access_log</code></h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token comment"># 日志文件的相对或完整路径</span>
  <span class="token directive"><span class="token keyword">access_log</span> /path/to/file.log</span><span class="token punctuation">;</span>
  
  <span class="token comment"># Turn 'on' or 'off'</span>
  <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|411">
                                <div class="section-title"><h3 id="id-459">杂项 <code>gzip</code>, <code>client_max_body_size</code></h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token comment"># Turn gzip compression 'on' or 'off'</span>
  <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  
  <span class="token comment"># Limit client body size to 10mb</span>
  <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">10M</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 633px">
                                <div class="h2-section-title"><h2 id="id-461">文件服务</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-460"></h3></div>
                                <div class="section-body">
                                    <h4>静态资源</h4>
<p>传统web服务</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
  	<span class="token directive"><span class="token keyword">root</span> /path/to/website</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>静态资源并使用 HTML5 History Mode</h4>
<p>单页应用，如<code>Vue</code>, <code>React</code>, <code>Angular</code>等</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">root</span> /path/to/website</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
  	<span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 484px">
                                <div class="h2-section-title"><h2 id="id-465">重定向</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-462"><code>301</code> 永久重定向</h3></div>
                                <div class="section-body">
                                    <p>可用于处理<code>www.yourdomain.com</code>和<code>yourdomain.com</code>，或者将<code>http</code>重定向到<code>https</code>。下面例子中<code>www.yourdomain.com</code>重定向到<code>yourdomain.com</code>。</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> www.yourdomain.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> http://yourdomain.com<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|42">
                                <div class="section-title"><h3 id="id-463"><code>302</code> 临时重定向</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">return</span> <span class="token number">302</span> http://otherdomain.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|233">
                                <div class="section-title"><h3 id="id-464">特殊URL的重定向</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /redirect-url</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> http://otherdomain.com</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 631px">
                                <div class="h2-section-title"><h2 id="id-468">反向代理</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-466">基本使用</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://0.0.0.0:3000</span><span class="token punctuation">;</span>
    <span class="token comment"># 0.0.0.0:3000 是本地服务绑定的ip和端口</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>或者先定义<code>upstream</code></p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">upstream</span> node_js</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server</span> 0.0.0.0:3000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://node_js</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|42">
                                <div class="section-title"><h3 id="id-467">升级连接（推荐用于Node.js应用程序）</h3></div>
                                <div class="section-body">
                                    <p>对于支持WebSockets（例如socket.io）的Node.js应用程序很有用。</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">upstream</span> node_js</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server</span> 0.0.0.0:3000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://node_js</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
	
    <span class="token comment"># not required but useful for applications with heavy WebSocket usage</span>
    <span class="token comment"># as it increases the default timeout configuration of 60</span>
    <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 764px">
                                <div class="h2-section-title"><h2 id="id-470">TLS/SSL (HTTPS)</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-469">基本使用</h3></div>
                                <div class="section-body">
                                    <p><em>以下配置只是TLS / SSL设置的一个示例。 不要将这些设置作为适用于您的应用程序的完美安全解决方案。 请研究最适合您的证书颁发机构的正确设置。</em></p>
<p>如果您正在寻找免费的SSL证书，则<a title="<em> Let's Encrypt </em>" href="https://letsencrypt.org/" target="_blank"><em> Let's Encrypt </em></a>是免费、自动、开放的证书颁发机构。另外，这是一个很棒的<a title="Digital Ocean指南" href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-16-04" target="_blank">Digital Ocean指南</a>，了解如何在Ubuntu 16.04上设置TLS / SSL。</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">ssl</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">ssl_certificate</span> /path/to/cert.pem</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /path/to/privkey.pem</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">ssl_stapling</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_stapling_verify</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_trusted_certificate</span> /path/to/fullchain.pem</span><span class="token punctuation">;</span>

  <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">1d</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">ssl_session_cache</span> shared:SSL:50m</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">add_header</span> Strict-Transport-Security max-age=15768000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment"># Permanent redirect for HTTP to HTTPS</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> yourdomain.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://<span class="token variable">$host</span><span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 764px">
                                <div class="h2-section-title"><h2 id="id-474">负载均衡</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-471">php-fpm Unix socket</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">upstream</span> php</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server</span> unix:/var/run/php/php-fpm.sock</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> unix:/var/run/php/php-two-fpm.sock</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">5</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>least_conn</code>选取活跃连接数与权重weight的比值最小者为下一个处理请求的server</p>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|42">
                                <div class="section-title"><h3 id="id-472">php-fpm TCP</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">upstream</span> php</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:9090</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:9091</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">5</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|293">
                                <div class="section-title"><h3 id="id-473">HTTP 负载均衡</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token comment"># Upstreams</span>
<span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">server</span> 10.10.10.1:80</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 10.10.10.2:80</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server_name</span> site.ltd</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>      <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    Host            <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Real-IP       <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 892px">
                                <div class="h2-section-title"><h2 id="id-479">代理</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-475">简单代理</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:3000</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>      <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    Host            <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Real-IP       <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|42">
                                <div class="section-title"><h3 id="id-476">子文件夹代理</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> /folder/</span> <span class="token punctuation">{</span> <span class="token comment"># The / is important!</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:3000/</span><span class="token punctuation">;</span> <span class="token comment"># The / is important!</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span>      <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    Host            <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Real-IP       <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span>    X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|0|273">
                                <div class="section-title"><h3 id="id-477">websocket keepalive 代理</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token comment"># Upstreams</span>
<span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:3000</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">5</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment"># HTTP Server</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server_name</span> site.tld</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/site.tld.access.log</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forward-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forward-Proto http</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Nginx-Proxy true</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|273">
                                <div class="section-title"><h3 id="id-478">反向代理 Apache</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>

    <span class="token directive"><span class="token keyword">server_name</span> domain.tld</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/domain.tld.access.log</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/domain.tld.error.log</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">root</span> /var/www/domain.tld/htdocs</span><span class="token punctuation">;</span>

    <span class="token comment"># pass requests to Apache backend</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># handle static files with a fallback</span>
    <span class="token directive"><span class="token keyword">location</span> ~* \.(ogg|ogv|svg|svgz|eot|otf|woff|woff2|ttf|m4a|mp4|ttf|rss|atom|jpe?g|gif|cur|heic|png|tiff|ico|zip|webm|mp3|aac|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|swf|webp)$</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">"Access-Control-Allow-Origin"</span> <span class="token string">"*"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">log_not_found</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">expires</span> max</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> @fallback</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># fallback to pass requests to Apache if files are not found</span>
    <span class="token directive"><span class="token keyword">location</span> @fallback</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                            <div class="h2-section" style="height: 359px">
                                <div class="h2-section-title"><h2 id="id-482">Nginx 安全</h2></div>
                                
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-480">访问限制</h3></div>
                                <div class="section-body">
                                    <h4>常用备份和存档文件</h4>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> ~* <span class="token string">"\.(old|orig|original|php#|php~|php_bak|save|swo|aspx?|tpl|sh|bash|bak?|cfg|cgi|dll|exe|git|hg|ini|jsp|log|mdb|out|sql|svn|swp|tar|rdf)$"</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>限制访问隐藏文件和文件夹</h4>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> ~ /\.(?!well-known\/)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                            <div class="sheet-section"  data-position="580|600|42">
                                <div class="section-title"><h3 id="id-481">阻止常见攻击</h3></div>
                                <div class="section-body">
                                    <h4>base64 encoded url</h4>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> ~* <span class="token string">"(base64_encode)(.*)(\()"</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>javascript eval() url</h4>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> ~* <span class="token string">"(eval\()"</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>
                            </div>
                            

                <div class="h2-section" style="height: 393px">
                    <div class="h2-section-title"><h2 id="id-485">Nginx Media</h2></div>
                    
                            <div class="sheet-section"  data-position="580|0|42">
                                <div class="section-title"><h3 id="id-483">MP4 stream module</h3></div>
                                <div class="section-body">
                                    <pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token directive"><span class="token keyword">location</span> /videos</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">location</span> ~ \.(mp4)$</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">mp4</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">mp4_buffer_size</span>       <span class="token number">1m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">mp4_max_buffer_size</span>   <span class="token number">5m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> Vary <span class="token string">"Accept-Encoding"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> <span class="token string">"Access-Control-Allow-Origin"</span> <span class="token string">"*"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">"public, no-transform"</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">log_not_found</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">expires</span> max</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                                </div>
                            </div>

                <div class="sheet-section"  data-position="580|600|42">
                    <div class="section-title"><h3 id="id-484">WebP images</h3></div>
                    <div class="section-body">
                        <p>Mapping conditions to display WebP images</p>
<pre class="language-nginx" tabindex="0"><code class="language-nginx" style=""><span class="token comment"># 如果Web浏览器支持WebP，则提供WebP图像</span>
<span class="token directive"><span class="token keyword">map</span> <span class="token variable">$http_accept</span> <span class="token variable">$webp_suffix</span></span> <span class="token punctuation">{</span>
   <span class="token directive"><span class="token keyword">default</span> <span class="token string">""</span></span><span class="token punctuation">;</span>
   "~*webp" ".webp"<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                    </div>
                </div>
                </div>
                
            </div>
            <div id="sheet-nav">
        <div class="nav-wrapper">
            <div class="nav-btn">
                <div class="nav-btn__item nav-btn-top">顶</div>
                <div class="nav-btn__item nav-btn-menu">菜</div>
            </div>
            <div class="nav-content hide">
                    <div class="nav-item nav-type-H3 hide" title="端口 listen" data-id="id-456" data-pid="default">
                    <span class="next-ctrl"></span> 端口 listen
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="域名 server_name" data-id="id-457" data-pid="default">
                    <span class="next-ctrl"></span> 域名 server_name
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="访问日志 access_log" data-id="id-458" data-pid="default">
                    <span class="next-ctrl"></span> 访问日志 access_log
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="杂项 gzip, client_max_body_size" data-id="id-459" data-pid="default">
                    <span class="next-ctrl"></span> 杂项 gzip, client_max_body_size
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="文件服务" data-id="id-461" data-pid="">
                    <span class="next-ctrl">+</span> 文件服务
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="重定向" data-id="id-465" data-pid="">
                    <span class="next-ctrl">+</span> 重定向
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="301 永久重定向" data-id="id-462" data-pid="id-465">
                    <span class="next-ctrl"></span> 301 永久重定向
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="302 临时重定向" data-id="id-463" data-pid="id-465">
                    <span class="next-ctrl"></span> 302 临时重定向
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="特殊URL的重定向" data-id="id-464" data-pid="id-465">
                    <span class="next-ctrl"></span> 特殊URL的重定向
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="反向代理" data-id="id-468" data-pid="">
                    <span class="next-ctrl">+</span> 反向代理
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="基本使用" data-id="id-466" data-pid="id-468">
                    <span class="next-ctrl"></span> 基本使用
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="升级连接（推荐用于Node.js应用程序）" data-id="id-467" data-pid="id-468">
                    <span class="next-ctrl"></span> 升级连接（推荐用于Node.js应用程序）
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="TLS/SSL (HTTPS)" data-id="id-470" data-pid="">
                    <span class="next-ctrl">+</span> TLS/SSL (HTTPS)
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="基本使用" data-id="id-469" data-pid="id-470">
                    <span class="next-ctrl"></span> 基本使用
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="负载均衡" data-id="id-474" data-pid="">
                    <span class="next-ctrl">+</span> 负载均衡
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="php-fpm Unix socket" data-id="id-471" data-pid="id-474">
                    <span class="next-ctrl"></span> php-fpm Unix socket
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="php-fpm TCP" data-id="id-472" data-pid="id-474">
                    <span class="next-ctrl"></span> php-fpm TCP
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="HTTP 负载均衡" data-id="id-473" data-pid="id-474">
                    <span class="next-ctrl"></span> HTTP 负载均衡
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="代理" data-id="id-479" data-pid="">
                    <span class="next-ctrl">+</span> 代理
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="简单代理" data-id="id-475" data-pid="id-479">
                    <span class="next-ctrl"></span> 简单代理
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="子文件夹代理" data-id="id-476" data-pid="id-479">
                    <span class="next-ctrl"></span> 子文件夹代理
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="websocket keepalive 代理" data-id="id-477" data-pid="id-479">
                    <span class="next-ctrl"></span> websocket keepalive 代理
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="反向代理 Apache" data-id="id-478" data-pid="id-479">
                    <span class="next-ctrl"></span> 反向代理 Apache
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="Nginx 安全" data-id="id-482" data-pid="">
                    <span class="next-ctrl">+</span> Nginx 安全
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="访问限制" data-id="id-480" data-pid="id-482">
                    <span class="next-ctrl"></span> 访问限制
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="阻止常见攻击" data-id="id-481" data-pid="id-482">
                    <span class="next-ctrl"></span> 阻止常见攻击
                    </div>
                
                    <div class="nav-item nav-type-H2 " title="Nginx Media" data-id="id-485" data-pid="">
                    <span class="next-ctrl">+</span> Nginx Media
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="MP4 stream module" data-id="id-483" data-pid="id-485">
                    <span class="next-ctrl"></span> MP4 stream module
                    </div>
                
                    <div class="nav-item nav-type-H3 hide" title="WebP images" data-id="id-484" data-pid="id-485">
                    <span class="next-ctrl"></span> WebP images
                    </div>
                </div>
        </div>
        </div>
        </div></div>

    



<script src="../js/util/function.js?version=2021082402"></script><script src="../js/util/event-hub.js?version=2021082402"></script><script src="../js/3rdparty/prism.js?version=2021082402"></script><script src="../js/module/loading.js?version=2021082402"></script><script src="../js/module/home.js?version=2021082402"></script><script src="../js/module/cheatsheet.js?version=2021082402"></script><script src="../js/module/menu.js?version=2021082402"></script><script src="../js/3rdparty/jszip.min.js?version=2021082402"></script><script src="../js/util/saveData.js?version=2021082402"></script></body></html>